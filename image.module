<?php
// $Id$

/**
 * System description used in the master module admin screen.
 */
function image_system($field) {
  $system["description"] = t("Provides shared and personal photo galleries.");
  $system["admin_help"] = t("Images can be uploaded into either shared or personal galleries. Once images are uploaded they can be manipulated.  The image system will auto-generate thumbnails for all images to be used in other nodes via filters and in gallery navigation.  These settings allow you to control where images are placed, how they are displayed, and any restrictions that should be enforced.");
  return $system[$field];
}

/**
 * Node descriptor
 */
function image_node($field) {
  $info["name"] = t("image");
  $info["description"] = t("An image you can insert into nodes, or see in photo galleries.");
  return $info[$field];
}

/**
 * Permissions this module exposes.
 */
function image_perm() {
  return array("has personal image gallery", "manipulate images", "access images", "create images", "administer images");
}

/**
 * Generate form to change admin settings used by this module.
 */
function image_settings() {

  $output .= form_textarea(t("Explanation or submission guidelines"), "image_help", variable_get("image_help", ""), 70, 5, t("This text will be displayed at the top of the image submission form.  It is useful for helping or instructing your users."));

  $output .= form_textfield(t("Default image path"), "image_default_path", variable_get("image_default_path", "images/"), 30, 255, t("Default path for uploaded images relative to your Drupal installation; it must be writeable and visible from the web. Don't forget the slash (/) at the end."));

  $output .= "<a name=\"image_default_thumb_path\"></a>";
  $output .= form_textfield(t("Default thumb path"), "image_default_thumb_path", variable_get("image_default_thumb_path", "images/thumbs/"), 30, 255, t("Default path for thumbnails relative to your Drupal installation; it must be writeable and visible from the web. Don't forget the slash (/) at the end."));

  $output .= "<a name=\"image_temp_path\"></a>";
  $output .= form_textfield(t("Temporary image path"), "image_temp_path", variable_get("image_temp_path", "./"), 30, 255, t("Path for working directory relative to your Drupal installation; it must be writeable and visible from the web. Don't forget the slash (/) at the end."));
  $output .= form_textfield(t("Maximum temporary image directory size"), "image_temp_path_size", variable_get("image_temp_path_size", 5), 6, 255, t("MBytes."));

  $output .= form_textfield(t("Default max image size"), "image_default_max_weight", variable_get("image_default_max_weight", "200"), 6, 255, t("KBytes."));
  $output .= form_textfield(t("Default max image resolution"), "image_default_max_size", variable_get("image_default_max_size", "1024x768"), 10, 255, t("Example: 800x600."));

  $output .= form_textfield(t("Default thumbnail resolution"), "image_default_thumb_size", variable_get("image_default_thumb_size", "100"), 10, 255, t("Default size of thumbnails: format will be the same as original image. Use just one dimension, and put a \"x\" to specify height. Examples: \"100\" for width of 100; \"x200\" for height of 200."));

  // Check which version of the GD library is available
  if (function_exists("imageCreateTrueColor")) {
    $libraries = array("imagemagick" => "imagemagick", "gd2" => "gd2");
  }
  else if (function_exists("imageCreate")) {
    $libraries = array("imagemagick" => "imagemagick", "gd1" => "gd1");
  }
  $output .= form_select(t("Image library"), "image_lib", variable_get("image_lib", "imagemagick"), $libraries, t("Select the image library to be used during thumbnail generation and image manipulation.  Use ImageMagick if you can; GD produces worse thumbnails, might not support GIF and this module doesn't support image editing (rotate, crop etc) with it."));

  if (variable_get("image_lib", "imagemagick") == "imagemagick") {
    $output .= form_textfield(t("Background Color"), "image_background", variable_get("image_background", "#000000"), 7, 7, t("Color used to fill in background when rotating images."));
    $output .= "<a name=\"image_convert\"></a>";
    $output .= form_textfield(t("Imagemagick Convert path"), "image_convert_path", variable_get("image_convert_path", "misc/image/convert.exe"), 50, 255, t("Absolute path to ImageMagick convert file. Include the 'convert.exe' (or other filename) at the end."));
  }

  $output .= "<a name=\"image_jhead\"></a>";
  $output .= form_textfield(t("jhead path"), "image_jhead_path", variable_get("image_jhead_path", ""), 50, 255, t("Absolute path of jhead, for EXIF parsing; blank to disable."));

  foreach (taxonomy_get_vocabularies("image") as $vid => $voc) {
    $vocs[$vid] = $voc->name;
  }
  $vocs[0] = t("<none>");
  $output .= "<a name=\"image_nav_vocabulary\"></a>";
  $output .= form_select(t("Gallery Navigation Vocabulary"), "image_nav_vocabulary", variable_get("image_nav_vocabulary", ""),   $vocs, t("One of the taxonomy vocabularies will be the navigation tree. Select it here. Make sure that a term from this vocabulary is required."));

  $output .= form_select(t("Gallery Thumbnails"), "image_gallery_thumb", variable_get("image_gallery_thumb", "last"), array("last" => "last", "random" => "random"), t("Set the thumbnail to be dislayed on the gallery page."));
  $output .= form_textfield("Gallery Rows", "image_gallery_thumb_rows", variable_get("image_gallery_thumb_rows", "5"), 5, 255, t("Specify how many rows of thumbnails in each page of the gallery."));
  $output .= form_textfield(t("Gallery Columns"), "image_gallery_thumb_cols", variable_get("image_gallery_thumb_cols", "3"), 5, 255, t("Specify how many columns of thumbnails in each page of the gallery."));
  $output .= form_select(t("Gallery Order"), "image_gallery_thumb_order", variable_get("image_gallery_thumb_order", "title"), array("title" => "title", "time" => "old -> new", "time desc" => "new -> old", "random" => "random", "weight" => "lighter -> heavier", "weight desc" => "heavier -> lighter"), t("Order of thumbnails within a gallery. Lighter and heavier refer to weight property."));

  $output .= form_select(t("Personal Photo Galleries"), "image_personal_gallery", variable_get("image_personal_gallery", "1"),   array("1" => "enabled", "0" => "disabled"), t("Activate/deactivate personal photo galleries site-wide.  When enabled you can use the \"has personal image gallery\" permission to control which roles have personal galleries."));
  if (variable_get("image_personal_gallery", "1") == "1") {
    $output .= form_textfield(t("Personal Gallery Picture Limit"), "image_personal_gallery_max_num", variable_get("image_personal_gallery_max_num", "50"), 5, 255, t("Set how many pictures users are allowed."));
    $output .= form_textfield(t("Personal Gallery Size Limit"), "image_gallery_max_kb", variable_get("image_gallery_max_kb", "1000"), 5, 255, t("Set a maximum number of kilobytes allowed per user."));
  }

  $output .= form_select(t("Disable Image Caching"), "image_random_suffix", variable_get("image_random_suffix", "0"), array("0" => "disabled", "1" => "enabled"), t("Enabling this will add random parameters to image URIs which will prevent the browser from caching."));

  return $output;
}


/**
 * Function called by cron.php to do clean up work for this module.
 *
 * Deletes all images in temp path older than 6 hours
 */
function image_cron() {
  // Clean up temp dir

  $old = getcwd();
  chdir(variable_get("image_temp_path", "./"));
  if ($handle = opendir(".")) {
    while (($file = readdir($handle)) != false) {
      if ($file != "." && $file != ".." && strpos($file, "tmpimg") != false) {
        // delete older than 6 hours
        if (time() - filemtime($file) > 60*60*6) {
          unlink($file);
        }
      }
    }
    closedir($handle);
  }
  chdir ($old);
}

/**
 * Function called to add any links for this module.
 *
 * $type - Is the type of link that is being requested (node, page, admin, etc..)
 * $node - Is the node that is the links would be relative to
 */
function image_link($type, $node, $main = 0) {
  global $user;

  // Add page level link if the user has access permissions and a vocabulary has been selected for navigation
  if ($type == "page" && user_access("access images") && variable_get("image_nav_vocabulary", "")) {
    $links[] = l(t("photo gallery"), "image");
  }

  // Add admin items if the user has administer permission
  if ($type == "admin" && user_access("administer images")) {
    $l_iptc = l("IPTC", "admin/image/help#iptc");
    $dir_help = "<p>Admins may create many image nodes at once by uploading all images to a folder on the server. This upload happens outside of Drupal, usually using an FTP client.</p>";
    $fast_help = "<h4>Fast Mode</h4>
      <ul>
       <li>Creates all image nodes at once without user interaction.</li>
       <li>Applies the same taxonomy term(s) to each node, thus creating a gallery.</li>
       <li>If $l_iptc data is present in the image, the headline and caption fields are used to populate the title and body respectively.</li>
       <li>If the image dimensions are bigger than the maximum allowed, the image is automatically scaled down.</li>
      </ul>
    ";

    $slow_help = "<h4>Slow Mode</h4>
      <ul>
        <li>Manipulate each image individually (i.e. crop, rotate, etc.).</li>
        <li>Add custom titles, descriptions, etc.</li>
      </ul>
    ";
    menu("admin/image", "image management", "_image_check_configuration", NULL, 8);
    menu("admin/image/dir_upload/slow", "directory upload: slow", "_image_dir_upload", $dir_help. $slow_help, 2);
    menu("admin/image/dir_upload/fast", "directory upload: fast", "_image_dir_upload_fast", $dir_help. $fast_help, 4);
    menu("admin/image/help", "help", "image_help", NULL, 12);
  }

  // Add a create link for images if the user has create permission
  if ($type == "menu.create" && (user_access("create images") || _image_can_personal())) {
    $links[] = l(t("create image"), "node/add/image", array("title" => t("Add a new image.")));
  }

  // Add view personaol gallery link if the user has personal gallery permission
  if ($type == "menu.view" && user_access("access images") && _image_can_personal()) {
    $links[] = l(t("view photo gallery"), "image/uid/$user->uid", array("title" => t("View your personal photo gallery.")));
  }

  // Add links to an image node
  if ($type == "node" && $node->type == "image") {
    // If you have access to update this node display update link
    if (image_access("update", $node)) {
      $links[] = l(t("edit this image"), "node/edit/$node->nid", array("title" => t("Edit this image.")));
    }

    // Display personal gallery links if this is a personal gallery photo
    if ($node->personal) {
      $links[] = l(t("%u's photo gallery", array("%u" => $node->name)), "image/uid/$node->uid", array("title" => t("View %u's photo gallery.", array("%u" => $node->name))));

      $sql = "SELECT n.nid, n.title, n.teaser, n.body, i.thumb_path FROM {node} n, {image} i WHERE n.nid = i.nid AND i.personal = 1 AND n.uid = ";
      $sql .= $node->uid;
      $sql .= " ORDER BY "._image_get_thumb_order();

    }

    // If this is not a personal gallery photo the display normal links
    else {

      $vid = variable_get("image_nav_vocabulary", "");
      if ($vid != "") {
        if (arg(3) == "tid") {
          $tid = arg(4);
          $term = taxonomy_get_term($tid);
        }
        else if (isset($node->taxonomy)) {
          foreach ($node->taxonomy as $tid) {
            if ($term = taxonomy_get_term($tid)) {
              if ($term->vid == $vid) break;
            }
          }
        }
        else {
          $terms = array_keys(taxonomy_node_get_terms_by_vocabulary($node->nid, $vid));
          $tid = $terms[0];
          $term = taxonomy_get_term($tid);
        }

        $links[] = l(t("%t photo gallery", array("%t" => $term->name)), "image/tid/" . $term->tid, array("title" => t("View %t photo gallery.", array("%t" => $terms->name))));

        $sql = "
          SELECT n.nid, n.title, n.teaser, n.body, i.thumb_path
          FROM {node} n, {term_node} t, {image} i
          WHERE n.nid = t.nid AND n.nid = i.nid AND i.personal = 0 AND t.tid = ";
        $sql .= $term->tid;
        $sql .= " ORDER BY "._image_get_thumb_order();
      }
    }

    // If we are not on the main page then display prev/next links
    if (!$main && $sql) {
      $result = db_query($sql);

      while ($image = db_fetch_object($result)) {
        if ($stop == 1) {
          $next->nid = $image->nid;
          $next->title = $image->title;
          break;
        }
        if ($image->nid == $node->nid) {
          $stop = 1;
        } else {
          $prev->nid = $image->nid;
          $prev->title = $image->title;
        }
      }

      if ($prev) {
        $links[] = l(t("previous image"), "node/view/$prev->nid", array("title" => $prev->title));
      }

      if ($next) {
        $links[] = l(t("next image"), "node/view/$next->nid", array("title" => $next->title));
      }
    }

  }

  return $links ? $links : array();
}

/**
 * Function to display photo gallery link on user information display.
 */
function image_user($type, $ahem, &$user) {
  if (user_access("access images")) {
    if ($type == "view_public") {
      $output .= form_item(t("Photo gallery"), l(t("view user's photo gallery"), "image/uid/$user->uid"));
    }

    return $output;
  }
}

/**
 * Function to determine whether a user has access to this node or not.
 *
 * Return 0 (or False) if the user should be denied access.
 * Return Any other value if the user should be granted access.
 */
function image_access($op, $node) {
  global $user;

  // For node view allow access if the node status is approved and they have access permissions
  if ($op == "view") {
    return ($node->status && user_access("access images"));
  }

  // For create access if theuser has create permissions
  if ($op == "create") {
    return user_access("create images") || _image_can_personal();
  }

  // Only allow the creator of the node to update it
  if ($op == "update") {
    return ($user->uid == $node->uid);
  }

  // Only allow the creator of the node to delete it
  if ($op == "delete") {
    return ($user->uid == $node->uid);
  }
}

/**
 * Display the image node
 */
function image_view($node, $main = 0) {

  // If random suffix is enabled or we have a new image add random suffix.
  if (variable_get("image_random_suffix", "0") || $node->image_id) {
    $rand = rand();
  }

  $node->teaser = check_output($node->teaser);
  $node->body = check_output($node->body);

  theme("node_image", $node, $rand, $main);
}

/**
 * Return form for adding and editing image nodes
 */
function image_form(&$node, &$help, &$error, &$param) {
  global $base_url;

  // Help
  $help = variable_get("image_help", "");

  // Taxonomy select form
  $output .= implode("", taxonomy_node_form("image", $node));

  if ($node->image_path) {
    $output .= form_item(t("Thumbnail"), "<img src=\"$base_url/$node->thumb_path\">");
  }

  if ($node->exif) {
    $output .= form_item(t("EXIF data"), _image_render_iptc_exif($node->exif));
  }

  if ($node->iptc) {
    $output .= form_item(t("IPTC data"), _image_render_iptc_exif($node->iptc));
  }

  if (user_access("manipulate images")  && $node->image_path) {
    $output .= _images_transform_form($node);
  }

  $output .= "<input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"".variable_get("image_default_max_weight", "200") * 1000 ."\">";
  $output .= form_file("Image", "image", 50, t("Click \"Browse...\" to select an image to upload.") . $error["image"]);

  $output .= form_textarea(t("Description"), "body", $node->body, 60, 5);

  $order = variable_get("image_gallery_thumb_order", "title");
  if ($order == "weight" || $order == "weight desc") {
    $output .= form_textfield(t("Weight"), "weight", $node->weight, 5, 255, t("Weight of image used to sort thumbnails.  Heavier thumbnails will fall to the bottom of the gallery."));
  }

  if (_image_can_personal() && user_access("create images")) {
    $output .= form_select(t("Personal"), "personal", $node->personal, array("0" => "disabled", "1" => "enabled"), t("A personal image can only be seen in the user's photo gallery."));
  }

  $output .= form_hidden("existing", $node->existing);

  $output .= form_hidden("image_id", $node->image_id);
  $output .= form_hidden("extension", $node->extension);

  $output .= "<br/>";

  // the guy who thought about this $param array is a genius
  $param["options"] = array("enctype" => "multipart/form-data",  "name" => "image_forms");

  return $output;
}

/**
 * Function to validate node contents.
 */
function image_validate(&$node) {

  // If this $node has an image_path already set we are editing
  // an existing image so set the existing flag.
  if ($node->image_path) {
    $node->existing = 1;
  }

  // If this is a slow directory upload pull the file name out of the query string
  if (arg(3) == "file" && !$node->image_id) {
    $upload_file = "";
    $i = 4;
    while ($tmp = arg($i)) {
      if ($i > 4) $upload_file .= "/";
      $upload_file .= $tmp;
      $i++;
    }
    $upload_name = basename($upload_file);
  }
  else {
    $upload_file = $_FILES["edit"]["tmp_name"]["image"];
    $upload_name = $_FILES["edit"]["name"]["image"];
  }
  if(!$node->image_id) $node->image_id = basename($upload_name, strrchr($upload_name, "."));

  // If we uploaded a file pre-process it
  if ($upload_file && $upload_file != "none") {

    if (!is_uploaded_file($upload_file) && arg(3) != "file") {
      switch($_FILES["edit"]["error"]["image"]) {
        case 1:
        case 2:
          $errortxt = t("The image you are trying to upload is too big.");
          break;
        case 3:
          $errortxt = t("The image you are trying to upload was only partially uploaded.");
          break;
        default:
          if (!$node->image_id && !$node->existing) {
            $errortxt = t("You must select an image for upload.");
          }
          break;
      }
      if ($errortxt) {
        $error["image"] = theme("theme_error", $errortxt);
      }
    }
    else {
      // Check File Size
      if ($errortxt = _check_filesize_limits($upload_file)) {
        $error["image"] = theme("theme_error", $errortxt);
      }
      else {
        $size = getimagesize($upload_file, $ipct_info);
        // Check to make sure what was uploaded is  an image
        if ((!in_array($size[2], array(1,2,3))) || (!_image_check_ext($upload_name))) {
          $error["image"] =  theme("theme_error", t("Uploaded file was not an image."));
        }
        else {
          $max_dim = split("x", variable_get("image_default_max_size", "1024x768"));
          if ($size[0] > $max_dim[0] || $size[1] > $max_dim[1]) {
            $error["image"] = theme("theme_error", t("The uploaded image(%ax%b) is to large (max %cx%d).", array("%a" => $size[0], "%b" => $size[1], "%c" => $max_dim[0], "%d" => $max_dim[1])));
          }
          else {
            // Generate image_id if necessary
            if (!$node->image_id) {
              srand ((double) microtime() * 1000000);
              $node->image_id = md5(rand());
            }
            // If we already have an image_id and an uploaded file delete it.
            else if (file_exists(_image_tempname($node))) {
              unlink(_image_tempname($node));
            }

            // Pull out iptc data and populate any node elements that are not already set.
            if ($proposed = _image_iptc_map($ipct_info)) {
              foreach ($proposed as $key => $value) {
                if (!$node->$key) {
                  $node->$key = $value;
                }
              }
            }

            // Save off the extension for the final filename
            $node->extension = _get_ext($upload_name);

            // Move file to temp area
            if (arg(3) == "file") {
              if (!rename($upload_file, _image_tempname($node))) {
                $error["image"] = theme("theme_error", t("Error processing image file."));
              }
            }
            else if (!move_uploaded_file($upload_file, _image_tempname($node))) {
              $error["image"] = theme("theme_error", t("Error processing image file."));
            }

            // Generate Thumbnail
            $errortxt = _image_make_thumbnail(_image_tempname($node), _image_tempthumbname($node));
            if ($errortxt) {
              $error["image"] = theme("theme_error", $errortxt);
            }

          } // Dimension Check

        } // File Type Check

      } // Filesize Check

    } // Uploaded File Check

  } // Image to process check

  else if (!$node->image_id && !$node->existing) {
    $error["image"] = theme("theme_error", t("You must select an image for upload."));
  }

  // If we have uploaded a new image so set the correct thumb and image paths
  if ($node->image_id) {
    $node->image_path = _image_tempname($node);
    $node->thumb_path = _image_tempthumbname($node);
  }
  // If we are editing an existing node and the image_path is not already set
  // load it from the database.
  else if ($node->existing && !$node->image_path) {
    $old_files = db_fetch_object(db_query("SELECT image_path, thumb_path FROM {image} WHERE nid = '%s'", $node->nid));
    $node->image_path = $old_files->image_path;
    $node->thumb_path = $old_files->thumb_path;
  }

  // Load up image node attributes if we have a file
  if ($node->image_path) {

    // We only need to load this if it hasn't already been loaded.
    if (!$size) {
      $size = getimagesize($node->image_path, $ipct_info);
    }

    $node->iptc = _image_iptc($ipct_info);
    $node->exif = _image_get_exif($node->image_path);

    $formats = array("1" => "gif", "2" => "jpg", "3" => "png");
    $node->format = $formats[$size[2]];
    $node->width = $size[0];
    $node->height = $size[1];
    $node->filesize = filesize($node->image_path);
  }

  // Image Manipulation
  if (user_access("manipulate images")  && !$node->manipulated && $node->image_path && (!$upload_file || $upload_file == "none")) {
    $width = $_POST["width"];
    $height = $_POST["height"];
    $rotate = $_POST["rotate"];
    $cropx = $_POST["cropx"];
    $cropy = $_POST["cropy"];
    $quality = $_POST["quality"];

    if ($cropx || $cropy) {
      $trasform_string .= " -crop ".$width."x".$height."+".$cropx."+".$cropy;
    }
    else if (($width && ($width != $node->width)) || ($height && ($height != $node->height))) {
      $trasform_string .= " -scale ".$width."x".$height ." -filter QUADRATIC";
    }

    if ($rotate) {
      $trasform_string .= " -rotate ".$rotate . " -background " . variable_get("image_background", "#000000");
    }

    if ($quality) {
      $trasform_string .= " -quality ".$quality;
    }

    if ($trasform_string && (variable_get("image_lib", "imagemagick") == "imagemagick")) {
      // Generate image_id if necessary
      if (!$node->image_id) {
        srand ((double) microtime() * 1000000);
        $node->image_id = md5(rand());

        // If this is an existing node then copy the orignal file
        if ($node->existing) {
          copy($node->image_path, _image_tempname($node));
        }

        $node->image_path = _image_tempname($node);
        $node->thumb_path = _image_tempthumbname($node);

      }

      echo _image_convert($node->image_path, $node->image_path, $trasform_string);

      // Generate New Thumbnail
      $errortxt = _image_make_thumbnail($node->image_path, $node->thumb_path);
      if ($errortxt) {
        $error["image"] = theme("theme_error", $errortxt);
      }

      // now let's reload size data
      $size = getimagesize($node->image_path, $ipct_info);
      $node->width = $size[0];
      $node->height = $size[1];
      $node->filesize = filesize($node->image_path);

      $node->manipulated = 1;
    }

  }

  // Force clear of personal flag if personal gallery is disabled or not allowed for this user
  if (!_image_can_personal()) {
    $node->personal = 0;
  }
  // If it is allowed and personal has not been set yet then default to personal gallery
  else if (!isset($node->personal)) {
    $node->personal = 1;
  }

  return $error;

}

/**
 * Function used to discover what filters are supplied by this module.
 */
function image_conf_filters() {
  $output = form_select(t("Image filter"), "image_filter_enabled", variable_get("image_filter_enabled", 0), array("Disabled", "Enabled"), t("When enabled, image codes will be replaced by thumb linked to real node. Syntax: [image:node_id,(left|right|top|middle|bottom|absmiddle|texttop|baseline),hspace,vspace,border]; every param but node_id is optional."));
  return $output;
}

/**
 * Actuall execute filter on given text.
 */
function image_filter($text) {
  if (variable_get("image_filter_enabled", 0)) {
    // *** [image:NID,(left|center|right)] ***
    // first we find every tag
    if (preg_match_all("/\[image:(\d+)(,(left|right|top|middle|bottom|absmiddle|texttop|baseline))?(,(\d+))?(,(\d+))?(,(\d+))?\]/i", $text, $match)) {
      // then we make the html
      foreach ($match[1] as $key => $value) {
	$map[$value] = $key;
      }
      $result = db_query("SELECT n.nid, n.teaser, i.thumb_path FROM {image} i, {node} n WHERE i.nid = n.nid AND n.nid IN ('".implode("','", array_map("check_query", $match[1]))."')");
      while ($img = db_fetch_object($result)) {
	$n = $map[$img->nid];
        $img->align = $match[3][$n];
        $img->hspace = $match[5][$n];
        $img->vspace = $match[7][$n];
        $img->border = $match[9][$n];
        $match[10][$n] = theme("image_inline_img", $img);
      }

      // PHP (4.3.2) str_replace appears to use some internal order
      // rather than array index when finding replace elements
      // corresponding to search elements.  To make sure that the
      // order of the arrays correspond, we make new copies here.
      foreach ($match[1] as $key => $value) {
	$mtch[] = $match[0][$key];
	$repl[] = $match[10][$key];
      }
      $text = str_replace($mtch, $repl, $text);
    }
  }
  return $text;
}

/**
 * I'm not exactly sure where this gets used.  I have not found where this displays in the UI.
 */
function image_compose_tips() {
  if (variable_get("image_filter_enabled", 0)) {
    return array(t("You may quickly link to image nodes using a special syntax. The image code(s) will be replaced by thumbnail linked to full size image node. Syntax: <i>[image:node_id,(left|right|top|middle|bottom|absmiddle|texttop|baseline),hspace,vspace,border]</i>. Every parameter except node_id is <i>optional</i>."));
  }
}

/**
 * Insert a new image nodes extra data into the datastore.
 */
function image_insert($node) {

  $node->image_path = _image_filename($node);
  $node->thumb_path = _image_thumbname($node);

  // Rename Image
  if (!rename(_image_tempname($node), $node->image_path)) {
    die(t("Cannot save image."));
  }

  // Rename Thumbnail
  if (!rename(_image_tempthumbname($node), $node->thumb_path)) {
    die(t("Cannot save image."));
  }

  db_query("INSERT INTO {image} (nid, image_path, thumb_path, format, width, height, filesize, iptc, exif, personal, weight) VALUES ('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')", $node->nid, $node->image_path, $node->thumb_path, $node->format, $node->width, $node->height, $node->filesize, serialize($node->iptc), serialize($node->exif), $node->personal, $node->weight);
}

/**
 * Update an image nodes extra data in the datastore.
 */
function image_update($node) {
  if ($node->image_id) {
    $old_files = db_fetch_object(db_query("SELECT image_path, thumb_path FROM {image} WHERE nid = '%s'", $node->nid));

    if (!unlink($old_files->image_path)) {
      echo t("Cannot delete old image.");
    };
    if (!unlink($old_files->thumb_path)) {
      echo t("Cannot delete old thumb.");
    };

    $node->image_path = _image_filename($node);
    $node->thumb_path = _image_thumbname($node);

    // Rename Image
    if (!rename(_image_tempname($node), $node->image_path)) {
      die(t("Cannot save image."));
    }

    // Rename Thumbnail
    if (!rename(_image_tempthumbname($node), $node->thumb_path)) {
      die(t("Cannot save image."));
    }
  }

  db_query("UPDATE {image} SET image_path = '%s', thumb_path = '%s', format = '%s', width = '%s', height = '%s', filesize = '%s', iptc = '%s', exif = '%s', personal = '%s', weight = '%s' WHERE nid = '%s'", $node->image_path, $node->thumb_path, $node->format, $node->width, $node->height, $node->filesize, serialize($node->iptc), serialize($node->exif), $node->personal, $node->weight, $node->nid);
}

/**
 * Function called to load image data given a node.
 */
function image_load($node) {
  $image = db_fetch_object(db_query("SELECT * FROM {image} WHERE nid = '%s'", $node->nid));
  $image->iptc = unserialize($image->iptc);
  $image->exif = unserialize($image->exif);

  return $image;
}


/**
 * Remove the image related data to the given node.
 */
function image_delete(&$node) {
  db_query("DELETE FROM {image} WHERE nid = '%s'", $node->nid);
  unlink($node->image_path);
  unlink($node->thumb_path);
}

/**
 * Returns the final image filename
 */
function _image_filename($node) {
  return variable_get("image_default_path", "images/") . _image_strip_name($node->image_id) ."-". $node->nid . $node->extension;
}

/**
 * Returns the final thumbnail filename
 */
function _image_thumbname($node) {
  return variable_get("image_default_thumb_path", "images/thumbs/")."thumb_"._image_strip_name($node->image_id) ."-". $node->nid . $node->extension;
}

/**
 * Returns the temporary image filename
 */
function _image_tempname($node) {
  return variable_get("image_temp_path", "./")."tmpimg_"._image_strip_name($node->image_id).$node->extension;
}

/**
 * Returns the temporary thumbnail filename
 */
function _image_tempthumbname($node) {
  return variable_get("image_temp_path", "./")."tmpthumb_"._image_strip_name($node->image_id).$node->extension;
}

/**
 * Returns a files extension.
 */
function _get_ext($filename) {
  return strtolower(strrchr($filename, "."));
}

/**
 * Returns true if the filename ends in a valid image extension.
 */
function _image_check_ext($filename) {
  return in_array(_get_ext($filename), array(".gif", ".jpg", ".png", ".jpeg"));
}

// returns an array with values proposed by IPTC info in the image
function _image_iptc_map($iptc_info) {

  $iptc = _image_iptc($iptc_info);

  if ($iptc["headline"]) {
    $proposed["title"] = $iptc["headline"];
  }
  // Photo shop displays graphic_name as title so map it if there is no headline
  else if ($iptc["graphic_name"]) {
    $proposed["title"] = $iptc["graphic_name"];
  }

  if ($iptc["caption"]) {
    $proposed["body"] = $iptc["caption"];
  }
  return $proposed;
}

function _image_iptc(&$info) {
  // credit to pkrohn@daemonize.com from php online manual for this
  if (isset($info["APP13"])) {
    $iptc = iptcparse($info["APP13"]);
    if (is_array($iptc)) {
      $result["caption"] = $iptc["2#120"][0];
      $result["graphic_name"] = $iptc["2#005"][0];
      $result["urgency"] = $iptc["2#010"][0];
      $result["category"] = $iptc["2#015"][0];
      // note that sometimes supp_categories contans multiple entries
      $result["supp_categories"] = $iptc["2#020"];
      $result["spec_instr"] = $iptc["2#040"][0];
      $result["creation_date"] = $iptc["2#055"][0];
      $result["photog"] = $iptc["2#080"][0];
      $result["credit_byline_title"] = $iptc["2#085"][0];
      $result["city"] = $iptc["2#090"][0];
      $result["state"] = $iptc["2#095"][0];
      $result["country"] = $iptc["2#101"][0];
      $result["otr"] = $iptc["2#103"][0];
      $result["headline"] = $iptc["2#105"][0];
      $result["source"] = $iptc["2#110"][0];
      $result["photo_source"] = $iptc["2#115"][0];
      $result["caption"] = $iptc["2#120"][0];
      $result["keywords"] = $iptc["2#025"];
      $result["caption_writer"] = $iptc["2#122"][0];
    }
  }
  return $result;
}

function _image_render_iptc_exif($iptc) {
  if (is_array($iptc)) {
    $n = 0;
    $output .= "<table>";
    $output .= "<tr>";
    foreach($iptc as $key => $value) {
      if ($n % 2 == 0) {
        $output .= "<tr>";
      }
      $output .= "<td><b>$key</b>: ".(is_array($value) ? implode(", ", $value) : $value)."</td>";
      if ($n % 2 == 1) {
        $output .= "</tr>";
      }
      $n++;
    }
    $output .= "</table>";
  }
  return $output;
}

/**
 * Helper function returns true if the current user has personal gallery permission and personal galleries are
 * turned on in the admin settings.
 */
function _image_can_personal() {
  return (user_access("has personal image gallery") && variable_get("image_personal_gallery", "1"));
}


function _image_get_iptc($file) {
  if (file_exists($file)) {
    getimagesize($file, $iptc);
  }
  return _image_iptc($iptc);
}

function _image_get_exif($file) {
  // ripped from gallery 1.2.5
  $_exif_path = variable_get("image_jhead_path", "");
  if ($_exif_path) {
    $return = exec($_exif_path." "._image_escape_shell($file), $results);

    #if ($return) {
      while (list($key,$value) = each($results)) {
          $explodeReturn = explode(':', $value, 2);
          $header = trim($explodeReturn[0]);
          if ($header != "File name" && $header != "File date" && $header != "File size" && $header != "Not JPEG") {
            $myExif[$header] = trim($explodeReturn[1]);
          }
      }

      return $myExif;
    #}
  }
}

function _image_make_thumbnail($imagename, $thumbname) {
  $lib = variable_get("image_lib", "imagemagick");
  if ($lib == "imagemagick") {
    return _image_convert($imagename, $thumbname, "-scale ".variable_get("image_default_thumb_size", "100")." -filter QUADRATIC");

  // Added support for version 1.xx and 2.xx of the GD library
  } else if ($lib == "gd2") {

    $size = GetImageSize($imagename);
    if ($size[2] == "2") {
      $type = "jpeg";
    } else if($size[2] == "3") {
      $type = "png";
    }
    $function = "imageCreateFrom".$type;
    $im = $function($imagename);

    list($thx, $thy) = split("x", variable_get("image_default_thumb_size", "100"));
    // X:x = Y:y
    if (!$thy) {
      $thy = round($size[1]*$thx/$size[0]);
    } else if (!$thx){
      $thx = round($size[0]*$thy/$size[1]);
    }
    $th = imageCreateTrueColor($thx, $thy);

    imageCopyResampled($th, $im, 0, 0, 0, 0, $thx, $thy, $size[0], $size[1]);

    $function = "image".$type;
    $function($th, $thumbname);

    imageDestroy($th);

  } else if ($lib == "gd1") {

    $size = @getimagesize($imagename);
    if ($size[2] == "2") {
      $type = "jpeg";
    } else if($size[2] == "3") {
      $type = "png";
    }
    $function = "imageCreateFrom".$type;
    $im = $function($imagename);

    list($thx, $thy) = split("x", variable_get("image_default_thumb_size", "100"));
    // X:x = Y:y
    if (!$thy) {
      $thy = round($size[1]*$thx/$size[0]);
    } else if (!$thx){
      $thx = round($size[0]*$thy/$size[1]);
    }

    $th = imageCreate($thx, $thy);
    // imageCopyResized doesn't produce very good results
    // You may use _imageCopyResampled() below instead, but it's much slower...
    imageCopyResized($th, $im, 0, 0, 0, 0, $thx, $thy, $size[0], $size[1]);
    //_imageCopyResampled($th, $im, $thx, $thy);

    $function = "image".$type;
    $function($th, $thumbname);

    imageDestroy($th);

  }
}


function _image_convert($source, $dest, $filter) {
  $_imagick_convert = variable_get("image_convert_path", "misc/image/convert.exe");
  if (!$_imagick_convert) {
    die(t("Imagemagick: you have to set <code>convert</code> path."));
  }

  // 040 = space
  $filter = preg_replace("/[^A-Za-z0-9\.\-\+\040]/","",$filter);
  $source = _image_escape_shell($source);
  $dest = _image_escape_shell($dest);
  $err = exec("$_imagick_convert $filter $source $dest");

  return $err;
}


function _image_escape_shell($filename) {

  if (strstr($_SERVER["SERVER_SOFTWARE"], "Win32")) {
  // I can't make escapeshellarg work on windows, it adds a '
  // this should be safe enough
    return '"'.addslashes(_image_strip_name($filename)).'"';
  }
  else {
    return escapeshellarg(_image_strip_name($filename));
  }
}


/**
 * Removes any invalid characters from the filename
 */
function _image_strip_name($filename) {
  // we don't allow filenames with strange characters
  // we try to convert some characters, and strip others
  $filename = strtr(urldecode($filename),
      "ÁÉÍÓÚÑÀÈÌÒÙÄËÏÖÜÂÊÎÔÛáéíóúñàèìòùäëïöüâêîôûç ",
      "aeiounaeiouaeiouaeiouaeiounaeiouaeiouaeiouc_");

  return strtolower(preg_replace("/[^A-Za-z0-9\.\-\+\/_]/","",$filename));
}

function _check_filesize_limits($image_file) {
  global $user;
  $user_images = db_fetch_object(db_query("SELECT COUNT(*) AS c, SUM(i.filesize) AS size FROM {image} i, {node} n WHERE i.personal = 1 AND i.nid = n.nid AND n.uid = ".$user->uid));

  $fsize = filesize($image_file);

  $max_num = variable_get("image_personal_gallery_max_num", "50");
  if ($user_images->c == $max_num) {
    $error = t("You can have at most %a images in your gallery.", array("%a" => $max_num));
  }

  else {
    $max_kb = variable_get("image_gallery_max_kb", "1000") * 1000;
    if (($user_images->size + $fsize) > $max_kb) {
      $error = t("You have %a kb for your gallery.", array("%a" => $max_kb));
    }

    else {

      $max_img_size = variable_get("image_default_max_weight", "200") * 1000;
      if ($fsize > $max_img_size)  {
        $error = t("File is too big (max %a kbytes)", array("%a" => $max_img_size));
      }

      else {
        $max_tmp_kb = variable_get("image_temp_path_size", 5) * 1000 * 1000;
        $tmp_dir_kb = _dirsize(variable_get("image_temp_path", "./"));

        if ($tmp_dir_kb + $fsize > $max_tmp_kb) {
          $error = t("Upload directory is full.");
        }
      }
    }
  }

  return $error;
}

function _dirsize($directory) {

  if (!is_dir($directory)) {
    return -1;
  }

  $size = 0;

  if ($DIR = opendir($directory)) {

    while (($dirfile = readdir($DIR)) !== false) {

    if (is_link($directory . '/' . $dirfile) || $dirfile == '.' || $dirfile == '..') {
        continue;
      }

      if (is_file($directory . '/' . $dirfile)) {
        $size += filesize($directory . '/' . $dirfile);
      }
      else if (is_dir($directory . '/' . $dirfile)) {
        $dirSize = _dirsize($directory . '/' . $dirfile);
        if ($dirSize >= 0) {
          $size += $dirSize;
        }
        else {
          return -1;
        }
      }
    }
    closedir($DIR);
  }

  return $size;
}

function _images_transform_form($node) {
  if (variable_get("image_lib", "imagemagick") != "imagemagick") {
    return "";
  }
  return '<br/>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr valign="top">
    <td>
      <div align="left"><b>'.t("Resize/Crop").':</b><br>
        <input type="text" name="cropx" size="7">
        Top X <br>
        <input type="text" name="cropy" size="7">
        Top Y <br>
        <input type="text" name="width" size="7" value="'.$node->width.'" onChange="if (prop.checked) { height.value = Math.round(width.value * ' . $node->height / $node->width . ') }">
        Width <br>
        <input type="text" name="height" size="7" value="'.$node->height.'" onChange="if (prop.checked) { width.value = Math.round(height.value * ' . $node->width / $node->height . ') }">
        Height<br>
        <input type="checkbox" name="prop" value="1" checked>
        '.t("keep prop").'
      </p>
    </td>
    <td>
      <div align="left"><b>'.t("Rotate").':</b><br>
        <input type="text" name="rotate" size="7">
        <br>
        ('.t("clockwise").')<br><!--
        <input type="text" name="background" size="7" value="FFFFFF"><br>'.t("background").'<br>(<a onclick="javascript:image_forms.background.value=\'FFFFFF\'; return false" href=\'#\'>'.t("white").'</a> - <a onclick="javascript:image_forms.background.value=\'000000\'; return false" href=\'#\'>'.t("black").'</a>)-->
      </div>
    </td>
    <td>
      <div align="left"><b>'.t("Convert").':</b><br>
        <input type="text" name="quality" size="5" maxlength="3"> '.t("Quality (1-100)").'<br>
      </div>
    </td>
  </tr>
</table>
';
}


/****
***** page function and friends
****/

function image_page() {

  if (arg(1) == "tid") {
    $tid = arg(2);
  }
  if (arg(1) == "uid") {
    $uid = arg(2);
  }
  if (arg(3) == "page") {
    $page = arg(4);
  }

  if (user_access("access images") && variable_get("image_nav_vocabulary", "")) {
    if ($uid) {
    // view user personal gallery
      $sql = "
        SELECT n.nid, n.title, n.body, i.thumb_path
        FROM {node} n, {image} i, {users} u
        WHERE n.nid = i.nid
        AND i.personal = 1
        AND n.uid = u.uid
        AND u.uid = '%s'
        ORDER BY
      ";

      $sql .= _image_get_thumb_order();

      $result = db_query($sql, $uid);

      while ($image = db_fetch_object($result)) {
        $images[] = $image;
      }

      $null = array();

      $galleryuser = user_load(array( "uid" => $uid));

      theme("header");
      theme("box", t("%u's Photo Gallery", array("%u" => $galleryuser->name)), theme("image_gallery_album", $null, $null, $images, $null, $galleryuser));
      theme("footer");
    }
    else if (!$tid) {
      // show albums
      $albums = taxonomy_get_children(0, variable_get("image_nav_vocabulary", ""));
      $albums = _image_album_properties($albums);

      theme("header");
      theme("box", t("Photo galleries"), theme("image_gallery_home", $albums));
      theme("footer");
    }
    else {
      // browse albums; show subalbums and thumbs
      $subalbums = taxonomy_get_children($tid, variable_get("image_nav_vocabulary", ""));
      $subalbums = _image_album_properties($subalbums);

      $sql = "
        SELECT n.nid, n.title, n.teaser, n.body, i.thumb_path
        FROM {node} n, {term_node} t, {image} i
        WHERE n.nid = t.nid
        AND n.nid = i.nid
        AND t.tid = '%s'
        AND i.personal = 0
      ";

      $result = db_query($sql, $tid);
      $data["total_images"] = db_num_rows($result);

      $sql .= "ORDER BY "._image_get_thumb_order();

      $thumb_num = variable_get("image_gallery_thumb_rows", "5") * variable_get("image_gallery_thumb_cols", "3");
      if (!$page) {$page = 1;}
      $offset = ($page - 1) * $thumb_num;
      $data["total_pages"] = ceil($data["total_images"] / $thumb_num);
      $data["page"] = $page;
      $data["tid"] = $tid;

      $result = db_query_range($sql, $tid, $offset, $thumb_num);
      while ($image = db_fetch_object($result)) {
        $images[] = $image;
      }

      $parents[] = taxonomy_get_term($tid);
      $n = 0;
      while ($parent = taxonomy_get_parents($parents[$n]->tid)) {
        $parents = array_merge($parents, $parent);
        $n++;
      }

      theme("header");
      theme("box", t("Photo galleries"), theme("image_gallery_album", $parents, $subalbums, $images, $data));
      theme("footer");
    }
  }
  else {
    theme("header");
    theme("box", t("Access denied"), message_access());
    theme("footer");
  }
}

function _image_get_thumb_order() {
  $order = variable_get("image_gallery_thumb_order", "title");
  switch($order) {
    case "title":
      return "n.title";
      break;
    case "time":
      return "n.created";
      break;
    case "time desc":
      return "n.created DESC";
      break;
    case "weight":
      return "i.weight";
      break;
    case "weight desc":
      return "i.weight DESC";
      break;
    default:
      return "RAND()";
  }
}

function _image_get_subalbums($tid, $recurse = 0) {
  // returns array of term ids of children, recursive
  static $subalbums;
  if (!$recurse) {
    $subalbums = array();
  }

  $_children = taxonomy_get_children($tid);
  foreach ($_children as $tid => $album) {
    $subalbums[$tid] = $album->name;
    _image_get_subalbums($tid, 1);
  }
  return $subalbums;
}

function _image_album_properties($albums) {
  // to every album add: how many images, last update, path of a thumbnail (, number of views, date of first image, something about comments)
  $tree = taxonomy_get_tree(variable_get("image_nav_vocabulary", "")); #, $parent = 0, $depth = -1
  foreach (array_keys($albums) as $term_id) {
    $terms = array();
    $children = taxonomy_get_tree(variable_get("image_nav_vocabulary", ""), $term_id, 1);
    $terms[] = $term_id;
    foreach ($children as $term) {
      $terms[] = $term->tid;
    }
    $result = db_query("SELECT COUNT(*) AS c FROM {term_node} t, {node} n, {image} i WHERE t.nid = n.nid AND i.nid = n.nid AND t.tid IN (". implode(",", $terms) .") AND i.personal = 0");
    while ($term = db_fetch_object($result)) {
      $albums[$term_id]->image_count = $term->c;
    }

    $last_update = db_fetch_object(db_query_range("SELECT n.created, i.thumb_path FROM {node} n INNER JOIN {image} i ON n.nid = i.nid INNER JOIN {term_node} t ON n.nid = t.nid WHERE t.tid IN (". implode(",", $terms) .") AND n.type = 'image' AND i.personal = 0 ORDER BY n.created DESC", 0, 1));
    $albums[$term_id]->last_updated = $last_update->created;
    $albums[$term_id]->thumb = $last_update->thumb_path;

    if (variable_get("image_gallery_thumb", "last") == "random") {
      $nodes = db_fetch_object(db_query("SELECT MIN(nid) as min, MAX(nid) as max FROM {node} WHERE type = 'image'"));
      $id = rand($nodes->min, $nodes->max);
      $random = db_fetch_object(db_query_range("SELECT i.thumb_path FROM {node} n INNER JOIN {image} i ON n.nid = i.nid INNER JOIN {term_node} t ON n.nid = t.nid WHERE t.tid IN (". implode(",", $terms) .") AND n.type = 'image' AND i.personal = 0 AND n.nid >= ". $id), 0, 1);
      $albums[$term_id]->thumb = $random->thumb_path;
    }
  }

  return $albums;
}

/**
 * Theme function to render image node.
 *
 */
function node_image($node, $rand, $main = 0) {
  global $base_url;

  if ($main)
  {
    if($rand) {
      $node->teaser = "<img class=\"thumb\" src=\"$base_url/$node->thumb_path?".$rand."\">" . $node->teaser;
    }
    else {
      $node->teaser = "<img class=\"thumb\" src=\"$base_url/$node->thumb_path\">" . $node->teaser;
    }
  }
  else {
    if($rand) {
      $node->body = "<img class=\"image\" src=\"$base_url/$node->image_path?".$rand."\">". $node->body;
    }
    else {
      $node->body = "<img class=\"image\" src=\"$base_url/$node->image_path\">". $node->body;
    }
  }

  theme("node", $node, $main);
}

function image_gallery_home($albums) {
  global $base_url;
  if ($albums) {
    $output .= "\n<div id=\"image\">\n<table>\n";

    foreach ($albums as $tid => $album) {
      $output .= "<tr>\n  <td align=\"center\">";
      if ($album->thumb) {
        $output .= l("<img src=\"$base_url/".$album->thumb."\" border=\"0\">", "image/tid/$album->tid");
      }
      $output .= "</td>\n  <td>";
      $output .= "<p class=\"album-name\">".l($album->name, "image/tid/$album->tid")."</p>";
      if ($album->description) {
        $output .= "<p class=\"album-description\">".check_output($album->description)."</p>";
      }
      if ($album->image_count) {
        $output .= "<p class=\"album-count\">";
        $output .= ($album->image_count) == 1 ? t("There is 1 image in this album.") : t("There are %a images in this album.", array("%a" => $album->image_count))."</p>";
      } else {
        $output .= "<p class=\"album-count\">".t("There are no images in this album.")."</p>";
      }
      if ($album->last_updated) {
        $output .= "<p class=\"album-updated\">".t("Last updated: ").format_date($album->last_updated)."</p>";
      }
      $output .= "</td></tr>\n";
    }

    $output .= "</table>\n</div> <!-- end of IMAGE div -->\n";
  }
  return $output;
}

function image_gallery_album($parents, $subalbums, $images, $data, $galleryuser = null) {
  global $base_url;

  if (!$galleryuser) {
    $t[] = l(t("galleries"), "image");
    foreach (array_reverse(array_values($parents)) as $p) {
      $t[] = l($p->name, "image/tid/$p->tid");
    }
    if ($t) {
      $output .= "&nbsp;".implode(":", $t);
      $output .= "<hr>";
    }
  }

  $sub = theme("image_gallery_home", $subalbums);
  if ($sub) {
    $output .= $sub."<hr>";
  }

  $n = 0;
  $thumbs_cols = variable_get("image_gallery_thumb_cols", "5");
  if ($images) {
    $output .= "\n<div id=\"image\">\n<table width=\"100%\" cellpadding=\"10\">";
    foreach ($images as $image) {
      if ($n % $thumbs_cols == 0) {
        $output .= "<tr>";
      }
      $output .= "<td valign=\"top\"><div align=\"center\">".l("<img src=\"$base_url/".$image->thumb_path."\" border=\"0\">", "node/view/$image->nid")."</div><p class=\"title\">".$image->title."</p><p class=\"teaser\">".$image->teaser."</p></td>\n";

      if ($n % $thumbs_cols == $thumbs_cols - 1) {
        $output .= "</tr>";
      }

      $n++;
    }
    if ($n % $thumbs_cols != 0) $output .= "</tr>";
    $output .= "</table>\n</div> <!-- end of IMAGE div -->";
  }

  $output .= theme("image_thumb_browser", $data);

  return $output;
}

function image_inline_img($img) {
  global $base_url;
  return l("<img src=\"$base_url/$img->thumb_path\" align=\"$img->align\" border=\"$img->border\" hspace=\"$img->hspace\" vspace=\"$img->vspace\" alt=\"$img->teaser\" />", "node/view/$img->nid");
}

function image_thumb_browser($data) {
  if ($data) {
    $output = '
    <hr>
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td colspan="5"><div align="center">'.
        format_plural($data["total_images"], "1 image", "%count images") .' '.
        t("in this album on") .' '.
        format_plural($data["total_pages"], "1 page", "%count pages") .'</div></td>
      </tr>
      <tr>
        <td width="10%">'.(($data["page"] > 1) ? l("|&lt;", "image/tid/". $data["tid"] ."/page/1") : "").'</td>
        <td width="10%">'.(($data["page"] > 1) ? l("&lt;&lt;", "image/tid/". $data["tid"] ."/page/". ($data["page"] - 1)) : "").'</td>
        <td>
          <div align="center">';

    for ($n = 1; $n <= $data["total_pages"]; $n++) {
      if ($n == $data["page"]) {
        $p[] = "<b>&raquo;$n&laquo;</b>";
      } else {
        $p[] = l($n, "image/tid/". $data["tid"] ."/page/$n");
      }
    }
    if ($p) {
      $output .= implode("&nbsp;&#149;&nbsp;", $p);
    }

    $output .= '
          </div>
        </td>
        <td width="10%">
          <div align="right">'.(($data["page"] < $data["total_pages"]) ? l("&gt;&gt;", "image/tid/". $data["tid"] ."/page/". ($data["page"] + 1)) : "").'</div>
        </td>
        <td width="10%">
          <div align="right">'.(($data["page"] < $data["total_pages"]) ? l("&gt;|", "image/tid/". $data["tid"] ."/page/". $data["total_pages"]) : "").'</div>
        </td>
      </tr>
    </table>';
  }

  return $output;
}

/****
***** admin function and friends
****/

function  _image_dir_upload_fast() {
   return _image_dir_upload("fast");
}

function _image_dir_upload($type = "slow", $edit = NULL) {
  global $user, $base_url;

  if(!$edit) $edit = $_POST["edit"];

  $links = array();

  if (!$edit["dir"]) {
    $output .= form_textfield(t("Directory to scan"), "dir", variable_get("image_last_upload_dir", ""), 30, 255, t("The path to the directory which holds the source image files. This path should be relative to Drupal root directory - don't forget the slash (/) at the end."));
    if ($type == "slow") {
      $output .= form_checkbox(t("Thumbnail"), "thumb", $value = 1, $checked = 0, t("Show resized image. Use only if you have large bandwidth."));
    }
    else {
      $output .= form_checkbox(t("Delete images after insert"), "del_images", $value = 1, $checked = 0, t("If instructed, Drupal will delete all files in the above directory after creating the image nodes."));
      foreach (taxonomy_get_vocabularies("image") as $vocab) {
        $links[] .= l($vocab->name, "admin/taxonomy/add/term/$vocab->vid");
      }
      $output .= form_item(t("Add new gallery"), implode(", ", $links), t("If needed, create a new term for this gallery by clicking on one of these vocabularies"));
      $output .= implode("<p>", taxonomy_node_form("image", $node));
    }
    $output .= form_submit(t("Directory upload"));
    $output =  form($output, "post");
  }
  else {
    // check for tricks
    $dir = str_replace ("../", "", "./".$edit["dir"]);
    if (!is_dir($dir)) {
      echo $edit["dir"] .t(" is not a directory");
      exit();
    }

    variable_set("image_last_upload_dir", $edit["dir"]);

    $handle = opendir($dir);
    while (($file = readdir($handle))!==false) {
      if ($file != "." && $file != ".." && !is_dir($file)) {
        if ($type == "slow") {
          if ($edit["thumb"]) {
            $output .= l($file, "node/add/image/file/". $dir.$file);
            $output .= " <img src=\"$base_url/$dir$file\" height=\"100\">";
          }
          else {
            $output .= l($file, "node/add/image/file/". $dir.$file);
          }
          $output .= "<br />";
        }
        else {
          $size = getimagesize("$dir/$file", $iptc_info);
          if ((in_array($size[2], array(1,2,3))) && (_image_check_ext($file))) {
            // move to a temporary location. _insert() will later move to final destination
            $node->image_id = md5(rand());
            $edit["del_images"] ? $action = "rename" : $action = "copy";
            if (!$action("$dir/$file", _image_tempname($node))) {
              die("cannot copy image to temporary location.");
            }

            $basename = basename($file, strrchr($file, "."));
            if ($edit[$basename]["title"]) {
              $node->title = $edit[$basename]["title"];
            }
            else {
              $node->title = $basename;
            }
            if (!$edit["uid"]) {
              $node->uid = $user->uid;
            }
            else {
              $node->uid = $edit["uid"];
            }
            if ($edit[$basename]["body"]) {
              $node->body = $edit[$basename]["body"];
            }
            $node->type = "image";
            $node->taxonomy = $edit["taxonomy"];
            $node->personal = 0;
            $node->weight = 5;
            $node->moderate = 0;

            $node->image_path = _image_tempname($node);
            $node->thumb_path = _image_tempthumbname($node);

            $node->iptc = _image_iptc($ipct_info);
            $node->exif = _image_get_exif($node->image_path);

            $formats = array("1" => "gif", "2" => "jpg", "3" => "png");
            $node->format = $formats[$size[2]];
            $node->width = $size[0];
            $node->height = $size[1];
            $node->filesize = filesize($node->image_path);

            //scale down image if needed
            if (variable_get("image_lib", "imagemagick") == "imagemagick") {
              $max_size = split("x", variable_get("image_default_max_size", "1024x768"));
              if ($size[0] > $max_size[0] || $size[1] > $max_size[1]) {
                $trasform_string .= " -scale ".$max_size[0]."x".$max_size[1] ." -filter QUADRATIC";
                _image_convert(_image_tempname($node), _image_tempname($node), $trasform_string);

                // Reset size;
                $size = getimagesize($node->image_path, $iptc_info);
                $node->width = $size[0];
                $node->height = $size[1];
                $node->filesize = filesize($node->image_path);
              }
            }

            //override defaults with any data specified in iptc header
            // Pull out iptc data and populate any node elements that are not already set.
            if ($proposed = _image_iptc_map($ipct_info)) {
              foreach ($proposed as $key => $value) {
                $node->$key = $value;
              }
            }

            // Generate Thumbnail
            _image_make_thumbnail($node->image_path, $node->thumb_path);

            $nid = node_save(array2object($node));

            if (!$alreadyprinted) {  // we only want to output this text once
              $output .= "\n" . t("You may wish to view your new images:") ." <p>\n";
              foreach ($node->taxonomy as $tid) {
                if ($term = taxonomy_get_term($tid)) {
                  $output .= t("gallery") .": ". l($term->name, "image/tid/$tid"). "<br />\n";
                }
              }
              $alreadyprinted = true;
            }
            $output .= "--  ". t("image") .": ". l($node->title, "node/view/$nid"). "<br />";
          }
        }
      }
    }
    closedir($handle);
  }
  return $output;
}

function _image_check_configuration() {
  // since we have to deal with a different directories, we check for correct permissions
  $dirs = array(
    "Default image path" => array("image_default_path", "images/"),
    "Default thumb path" => array("image_default_thumb_path", "images/thumbs/"),
    "Temporary image path" => array("image_temp_path", "./")
    );
  foreach ($dirs as $description => $key) {
    print $description.":";
    if (!file_exists(variable_get($key[0], $key[1]))) {
      print "<div class=\"error\">DOES NOT EXIST - fix in ". l("Site Configuration", "admin/system/modules/image#$key[0]");
    }
    else if (!is_writable(variable_get($key[0], $key[1]))) {
      print "<div class=\"error\">NOT WRITABLE - change permissions on server";
    }
    else if (substr(variable_get($key[0], $key[1]), -1) != "/") {
      print "<div class=\"error\">PATH DOES NOT END in SLASH (/) - fix in ". l("Site Configuration", "admin/system/modules/image#$key[0]");
    }
    else {
      echo "<div class=\"ok\">OK";
    }
    echo "</div>";
  }

  // finally we also check for convert
  $convert = variable_get("image_convert_path", "misc/image/convert.exe");
  echo "ImageMagick convert:";
  if ($convert) {
    if (!file_exists($convert)) {
      echo "<div class=\"error\">DOES NOT EXIST - fix in ". l("Site Configuration", "admin/system/modules/image#image_convert");
    }
    else {
      echo "<div class=\"ok\">OK";
    }
  }
  else {
    echo "<div class=\"disabled\">disabled";
  }
  echo "</div>";

  // and jhead
  $jhead = variable_get("image_jhead_path", "");
  echo "jhead:";
  if ($jhead) {
    if (!file_exists($jhead)) {
      echo "<div class=\"error\">DOES NOT EXIST - fix in ". l("Site Configuration", "admin/system/modules/image#image_jhead");
    }
    else {
      echo "<div class=\"ok\">OK";
    }
  }
  else {
    echo "<div class=\"disabled\">disabled";
  }
  echo "</div>";

  // check if he assigned a vocabulary, for photo album navigation
  if (!variable_get("image_nav_vocabulary", "")) {
    echo "<div class=\"error\">Warning: you must assign a vocabulary to navigate in photo gallery. Fix in ". l("Site Configuration", "admin/system/modules/image#image_nav_vocabulary"). "</div>";
  }
}


function image_help() {
  global $base_url;

?>

<h4>Configuration</h4>

<h5>Image Library</h5>

<p><a href="http://www.imagemagick.org/">Imagemagick</a> and <a href="http://www.boutell.com/gd/">GD</a> are supported image libraries. 
Imagemagick is required for full image manipulation features and is suggested for better thumbnail quality.</p>

<p>Many ISPs already have Imagemagick installed and available for your use.
 If you are hosted on Linux and have shell access, type <i>which convert</i>
 at the command prompt This will tell you where the binary is, if it is in the path.
 The name of the binary on most unixoid systems is simply <i>convert</i>.</p>

<p>If you choose to use the GD library, you should install version 2.0 or higher.
 However, version 1.x of the GD library is supported, even if it produces lower quality images.
 In order to use GD PHP must be compiled with GD enabled.</p>

<a name="iptc"><h5>IPTC</h5></a>

<p>JPEG images may be tagged with information about the image. This information talks about the
 caption, headline, creation date, location, and many other parameters about the image. To
 embed IPTC data in your images, use an IPTC aware editor like
 <a href="http://www.pixvue.com">PixVue</a> (free, Windows only),
 <a href="http://www.adobe.com/products/photoshop/main.html">Photoshop</a>
 (commercial, Windows/Mac), or <a href="http://www.photo.net/bboard/q-and-a-fetch-msg?msg_id=001Lso">possibly GIMP</a> (Linux, Unix, Windows).</p>

<p>This module reads any IPTC info in your image, and uses it appropriately. Fast directory upload of IPTC
 images is the quickest and most complete way to add lots of images into Drupal. Further, you may tag
 your images while offline and only go online to do the upload/creation in Drupal.</p>

<h5>EXIF</h5>

<p>JPEG images may also be tagged with information about the camera settings used to take the picture.</p>

<p>This module can read EXIF information about your images via <a href="http://www.sentex.net/~mwandel/jhead/">jhead</a>.</p>

<h5>Image Storage</h5>

<p>All directories must be readable and writeable for the user id that the web server runs under.</p>

<h5>Verifiying Configuration</h5>

<p>You can verify your directory and image library application configuration by visiting the <a href="<?php echo $base_url; ?>/?q=admin/image">image mangagement administration scrren</a>.</p>

<h4>Adding images into other nodes</h4>
<p>Sometimes, you want to add an image to another node like a blog entry or a story.
 You may do this by creating an image node in Drupal for the target image, and then
 referencing that image in your story, blog, etc. To enable this feature and learn the
 proper syntax, visit the <a href="<?php echo $base_url; ?>/?q=admin/system/filters">filters configuration screen</a>.</p>

<?php
}

// Alternative function to GD 1.x imageCopyResized which produce better results
// (found on www.php.net)
function _imageCopyResampled ($dst, &$src, $x, $y) {
  /*
  Function derived from ImageCopyResampleBicubic()
  Original code in C, for the PHP GD Module by jernberg@fairytale.se
  Port to PHP by John Jensen July 10 2001
  Updated by tim@smoothdeity.com
  Re-edited & optimized by TCK
  */
  $pals = ImageColorsTotal ($src);
  ImagePaletteCopy ($dst,$src);
  $scX =(imagesx ($src)-1)/$x;
  $scY =(imagesy ($src)-1)/$y;
  $scX2 =intval($scX/2);
  $scY2 =intval($scY/2);
  for ($j = 0; $j < ($y); $j++) {
    $sY = intval($j * $scY);
    $y13 = $sY + $scY2;
    for ($i = 0; $i < ($x); $i++) {
      $sX = intval($i * $scX);
      $x34 = $sX + $scX2;
      $c1 = ImageColorsForIndex ($src, ImageColorAt ($src, $sX, $y13));
      $c2 = ImageColorsForIndex ($src, ImageColorAt ($src, $sX, $sY));
      $c3 = ImageColorsForIndex ($src, ImageColorAt ($src, $x34, $y13));
      $c4 = ImageColorsForIndex ($src, ImageColorAt ($src, $x34, $sY));
      $r = ($c1['red']+$c2['red']+$c3['red']+$c4['red'])/4;
      $g = ($c1['green']+$c2['green']+$c3['green']+$c4['green'])/4;
      $b = ($c1['blue']+$c2['blue']+$c3['blue']+$c4['blue'])/4;
      ImageSetPixel ($dst, $i, $j, ImageColorClosest ($dst, $r, $g, $b));
    }
  }
}
?>
